%global _lto_cflags %nil
%global _clang_extra_ldflags %nil
%global toolchain clang

Name:    yass
Version: __VERSION__
Release: __SUBVERSION__%{?dist}
Summary: lightweight and secure http/socks4/socks5 proxy

License: GPLv2
URL: https://github.com/Chilledheart/yass
Source0: https://github.com/Chilledheart/yass/archive/refs/tags/%{version}.tar.gz
%if 0%{?rhel} == 9 || 0%{?fedora}
BuildRequires: gtk4-devel
%else
BuildRequires: gtk3-devel
%endif
%if 0%{?rhel} < 9 || 0%{?fedora}
BuildRequires: perl
%endif
%if 0%{?rhel} >= 8 || 0%{?fedora}
BuildRequires: cmake >= 3.12, pkg-config
%endif
%if 0%{?rhel} == 7
BuildRequires: cmake3 >= 3.12, pkgconfig
%endif
BuildRequires: ninja-build, gcc, gcc-c++, golang >= 1.4
BuildRequires: glib2-devel

%description
Yet Another Shadow Socket is a lightweight and secure http/socks4/socks5 proxy for
embedded devices and low end boxes.

%prep
%setup -q -n %{name}-%{version}

%build
mkdir build
cd build
ENABLE_LLD=on
[ "a$DISABLE_LLD" != "a" ] && ENABLE_LLD=off
cmake3 -G Ninja -DBUILD_BENCHMARKS=on -DBUILD_TESTS=on -DCMAKE_BUILD_TYPE=Release -DGUI=on -DCLI=on -DSERVER=on -DENABLE_LLD="$ENABLE_LLD" ..
ninja
cd ..

%check
cd build
./yass_test
./yass_benchmark
cd ..

%install
cd build
cmake3 -DCMAKE_INSTALL_PREFIX=%{buildroot}/usr ..
rm -rf %{buildroot}
ninja install
cd ..
rm -rf %{buildroot}/usr/include
rm -rf %{buildroot}/usr/lib64
rm -rf %{buildroot}/usr/share/doc
rm -rf %{buildroot}/usr/share/man
rm -rf %{buildroot}/usr/share/yass/fetch-ocsp-response

%post
update-desktop-database

%files
%defattr(-,root,root)
%license LICENSE
%dir /usr/share/icons/hicolor/
%dir /usr/share/applications/
%dir /usr/share/pixmaps/
%{_bindir}/yass
%{_datadir}/applications/yass.desktop
%{_datadir}/pixmaps/yass.png
%{_datadir}/icons/hicolor/16x16/apps/yass.png
%{_datadir}/icons/hicolor/22x22/apps/yass.png
%{_datadir}/icons/hicolor/24x24/apps/yass.png
%{_datadir}/icons/hicolor/32x32/apps/yass.png
%{_datadir}/icons/hicolor/48x48/apps/yass.png
%{_datadir}/icons/hicolor/128x128/apps/yass.png
%{_datadir}/icons/hicolor/256x256/apps/yass.png
%{_datadir}/icons/hicolor/512x512/apps/yass.png
%{_datadir}/locale/en/LC_MESSAGES/yass.mo

%package server
Summary: lightweight and secure http/socks4/socks5 proxy (server side)

%description server
Yet Another Shadow Socket is a lightweight and secure http/socks4/socks5 proxy for
embedded devices and low end boxes.

%files server
%defattr(-,root,root)
%{_bindir}/yass_server

%package client
Summary: lightweight and secure http/socks4/socks5 proxy (client side)

%description client
Yet Another Shadow Socket is a lightweight and secure http/socks4/socks5 proxy for
embedded devices and low end boxes.

%files client
%defattr(-,root,root)
%{_bindir}/yass_cli

%changelog
* Mon Mar 13 2023 Chilledheart <hukeyue@hotmail.com> - 1.3.0-1
  - New HTTP TLS Implementation.
* Wed Mar 8 2023 Chilledheart <hukeyue@hotmail.com> - 1.2.7-1
  - New bug-fix release.
* Wed Mar 1 2023 Chilledheart <hukeyue@hotmail.com> - 1.2.6-1
  - New bug-fix release.
* Thu Feb 16 2023 Chilledheart <hukeyue@hotmail.com> - 1.2.5-1
  - New bug-fix release.
* Sat Feb 11 2023 Chilledheart <hukeyue@hotmail.com> - 1.2.4-1
  - New bug-fix release.
* Fri Feb 10 2023 Chilledheart <hukeyue@hotmail.com> - 1.2.3-1
  - New bug-fix release.
* Wed Feb 8 2023 Chilledheart <hukeyue@hotmail.com> - 1.2.2-1
  - New bug-fix release.
* Fri Feb 3 2023 Chilledheart <hukeyue@hotmail.com> - 1.2.1-1
  - New bug-fix release.
* Sun Jan 29 2023 Chilledheart <hukeyue@hotmail.com> - 1.2.0-1
  - New HTTP2 Tunnel Proxy Support.
* Tue Jan 10 2023 Chilledheart <hukeyue@hotmail.com> - 1.1.0-1
  - New bug-fix release.
* Sat Jan 22 2022 Chilledheart <rwindz0@gmail.com> - 1.0.0-1
  - Initial release. (Closes: #4)
