#!/usr/bin/make -f
# -*- makefile -*-
# See debhelper(7) (uncomment to enable)
# output every command that modifies files on the build system.
#export DH_VERBOSE = 1

# Security Hardening
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
NCPUS = $(shell nproc)

export GOPROXY

# In compat 13 and later, The variables HOME will be set to a writable directory
export HOME=/tmp

DOPACKAGES := $(shell dh_listpackages)

%:
	dh $@ --builddirectory=build

override_dh_auto_clean:
	dh_auto_clean

override_dh_auto_configure:
ifneq (,$(filter yass,$(DOPACKAGES)))
	dh_auto_configure ${DEB_BUILD_SYSTEM_OPTIONS} -- -DCMAKE_BUILD_TYPE=Release -DUSE_HOST_TOOLS=on -DCMAKE_EXE_LINKER_FLAGS="-static-libstdc++ -static-libgcc" -DGUI=on -DCLI=on -DSERVER=on ${CMAKE_CROSS_TOOLCHAIN_FLAGS_NATIVE}
else
	dh_auto_configure ${DEB_BUILD_SYSTEM_OPTIONS} -- -DCMAKE_BUILD_TYPE=Release -DUSE_HOST_TOOLS=on -DCMAKE_EXE_LINKER_FLAGS="-static-libstdc++ -static-libgcc" -DGUI=off -DCLI=on -DSERVER=on ${CMAKE_CROSS_TOOLCHAIN_FLAGS_NATIVE}
endif

override_dh_auto_build:
	dh_auto_build -- -j $(NCPUS)

override_dh_auto_test:
	echo 'no test'

override_dh_shlibdeps:
	dh_shlibdeps -l /usr/$(DEB_HOST_GNU_TYPE)/lib -l /lib/$(DEB_HOST_GNU_TYPE)

override_dh_strip:
ifneq (,$(filter yass,$(DOPACKAGES)))
	dh_strip -pyass --dbg-package=yass-dbg
endif
	dh_strip -pyass-server --dbg-package=yass-server-dbg
	dh_strip -pyass-client --dbg-package=yass-client-dbg

override_dh_auto_install:
	dh_auto_install
	rm -rf $(CURDIR)/debian/tmp/usr/lib $(CURDIR)/debian/tmp/usr/include $(CURDIR)/debian/tmp/usr/bin/protoc*
